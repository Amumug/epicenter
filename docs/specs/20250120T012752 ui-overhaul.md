# UI Overhaul Implementation Spec

**Date**: 2025-01-20  
**Feature**: Complete UI restructuring for workspace/session/message hierarchy

## Problem Statement

The current UI doesn't properly reflect the hierarchical relationship between workspaces, sessions, and messages. Additionally:
- Workspace management is not exposed in the UI
- Session queries don't pass workspace context correctly
- Message interface lacks mode selection and file upload capabilities
- No clear navigation between hierarchy levels

## Architecture Overview

### Data Hierarchy
```
Workspaces (stored locally)
  └── Sessions (API managed, workspace-scoped)
       └── Messages (real-time SSE, session-scoped)
```

### Key Design Decisions
1. **Workspace-first navigation**: All routes require workspace context
2. **Real-time messages**: Use existing `messages.svelte.ts` SSE subscription
3. **File uploads**: Leverage existing FileDropZone component from @repo/ui
4. **Accessor pattern**: Maintain for all query layer functions

## Implementation Plan

### Phase 1: Route Structure

New route hierarchy:
```
/workspaces                               # List all workspaces
/workspaces/[id]                          # View workspace (shows sessions)
/workspaces/[id]/sessions/[sessionId]     # View session (shows messages)
```

### Phase 2: Workspace Management

#### Components to Create

**WorkspaceList.svelte**
- Table view using shadcn Table component
- Columns: Name, URL, Port, Last Used, Actions
- Actions: Edit, Delete, Connect
- Empty state when no workspaces

**WorkspaceCard.svelte**
- Card display for individual workspace
- Show connection status indicator
- Quick actions (edit, delete)

**CreateWorkspaceDialog.svelte**
- Form fields: name, url, port, username, password
- Use Dialog and Form components
- Auto-generate port using `generateRandomPort()`

**EditWorkspaceDialog.svelte**
- Pre-fill form with existing workspace data
- Allow editing all fields except ID

**WorkspaceSelector.svelte**
- Dropdown/Select component for quick switching
- Show current workspace name
- List all workspaces for switching

### Phase 3: Session Management Updates

#### Fix Existing Components
1. Uncomment and fix CreateSessionDialog
2. Update SessionList to accept workspace prop
3. Add workspace parameter to all session queries

#### Query Updates
```typescript
// All session queries need workspace accessor
const sessionsQuery = createQuery(
  rpc.sessions.getSessions(() => currentWorkspace).options
);
```

### Phase 4: Message Interface Enhancement

#### MessageInput.svelte Updates
```svelte
<script lang="ts">
  import * as Select from '@repo/ui/select';
  import { FileDropZone, ACCEPT_AUDIO, ACCEPT_VIDEO, MEGABYTE } from '@repo/ui/file-drop-zone';
  import { Button } from '@repo/ui/button';
  import { Textarea } from '@repo/ui/textarea';
  import { PaperclipIcon } from '@lucide/svelte';
  
  let {
    value = $bindable(''),
    onSubmit,
    disabled = false,
    placeholder = 'Type your message...',
    mode = $bindable('chat'),
    onFileUpload
  } = $props();
  
  let showFileUpload = $state(false);
  let uploadedFiles = $state<File[]>([]);
</script>

<div class="space-y-2">
  <div class="flex items-center gap-2">
    <Select.Root bind:value={mode}>
      <Select.Trigger class="w-32">
        <Select.Value placeholder="Mode" />
      </Select.Trigger>
      <Select.Content>
        <Select.Item value="chat">Chat</Select.Item>
        <Select.Item value="code">Code</Select.Item>
        <Select.Item value="explain">Explain</Select.Item>
        <Select.Item value="summarize">Summarize</Select.Item>
      </Select.Content>
    </Select.Root>
    
    <Button
      variant="ghost"
      size="icon"
      onclick={() => showFileUpload = !showFileUpload}
    >
      <PaperclipIcon class="h-4 w-4" />
    </Button>
  </div>
  
  {#if showFileUpload}
    <FileDropZone
      accept="{ACCEPT_AUDIO}, {ACCEPT_VIDEO}"
      maxFiles={5}
      maxFileSize={25 * MEGABYTE}
      onUpload={(files) => {
        uploadedFiles = files;
        if (onFileUpload) onFileUpload(files);
      }}
      class="h-24"
    />
  {/if}
  
  {#if uploadedFiles.length > 0}
    <div class="flex flex-wrap gap-1">
      {#each uploadedFiles as file}
        <Badge variant="secondary">
          {file.name}
          <button onclick={() => removeFile(file)}>×</button>
        </Badge>
      {/each}
    </div>
  {/if}
  
  <div class="flex gap-2">
    <Textarea ... />
    <Button ... />
  </div>
</div>
```

### Phase 5: Query Layer Updates

#### Create lib/query/messages.ts
```typescript
import * as api from '$lib/client/sdk.gen';
import type { UserMessagePart } from '$lib/client/types.gen';
import { createWorkspaceClient } from '$lib/client/workspace-client';
import { ShErr } from '$lib/result';
import type { Workspace } from '$lib/stores/workspaces.svelte';
import { extractErrorMessage } from 'wellcrafted/error';
import { Ok } from 'wellcrafted/result';
import { defineMutation } from './_client';

export const sendMessage = defineMutation({
  mutationKey: ['sendMessage'],
  resultMutationFn: async ({ 
    workspace, 
    sessionId, 
    mode = 'chat',
    parts 
  }: { 
    workspace: Workspace; 
    sessionId: string;
    mode?: string;
    parts: UserMessagePart[];
  }) => {
    const client = createWorkspaceClient(workspace);
    
    // TODO: Get provider/model from workspace or settings
    const { data, error } = await api.postSessionByIdMessage({
      client,
      path: { id: sessionId },
      body: { 
        providerID: 'openai', // This should come from workspace/settings
        modelID: 'gpt-4',      // This should come from workspace/settings
        mode,
        parts 
      }
    });
    
    if (error) {
      return ShErr({
        title: 'Failed to send message',
        description: extractErrorMessage(error)
      });
    }
    return Ok(data);
  }
});

// Re-export the helper functions from messages.svelte.ts
export { isMessageProcessing, isSessionProcessing } from '$lib/stores/messages.svelte';
```

### Phase 6: Navigation & State Management

#### Current Workspace Store
```typescript
// lib/stores/current-workspace.svelte.ts
import { getWorkspace } from './workspaces.svelte';

let currentWorkspaceId = $state<string | null>(null);

export const currentWorkspace = {
  get value() {
    return currentWorkspaceId ? getWorkspace(currentWorkspaceId) : null;
  },
  set(id: string | null) {
    currentWorkspaceId = id;
  }
};
```

#### Breadcrumb Navigation
Use shadcn Breadcrumb component:
```svelte
<Breadcrumb.Root>
  <Breadcrumb.List>
    <Breadcrumb.Item>
      <Breadcrumb.Link href="/workspaces">Workspaces</Breadcrumb.Link>
    </Breadcrumb.Item>
    <Breadcrumb.Separator />
    <Breadcrumb.Item>
      <Breadcrumb.Link href="/workspaces/{workspaceId}">
        {workspace.name}
      </Breadcrumb.Link>
    </Breadcrumb.Item>
    <Breadcrumb.Separator />
    <Breadcrumb.Item>
      <Breadcrumb.Page>{session.title || 'Untitled Session'}</Breadcrumb.Page>
    </Breadcrumb.Item>
  </Breadcrumb.List>
</Breadcrumb.Root>
```

### Phase 7: UI Polish

#### Empty States
- No workspaces: "Create your first workspace to get started"
- No sessions: "Start a new conversation"
- No messages: "Send a message to begin"

#### Loading States
- Use Skeleton component for loading workspaces/sessions
- Show typing indicator for assistant responses
- Loading spinner for file uploads

#### Error Handling
- Toast notifications for all errors
- Retry buttons where appropriate
- Clear error messages

## Technical Considerations

### Type Safety
- Extend Workspace type if needed for provider/model settings
- Ensure all UserMessagePart types are handled
- Validate file types and sizes

### Performance
- Lazy load workspace details
- Virtualize long message lists if needed
- Debounce message input

## Testing Plan

1. Test workspace CRUD operations
2. Verify session creation with workspace context
3. Test message sending with different modes
4. Verify file upload functionality
5. Test real-time message updates
6. Verify navigation flow

## Migration Notes

- Existing workspaces in localStorage will work as-is
- No data migration needed
- Users will need to navigate to /workspaces initially

## Success Criteria

- [ ] Clear hierarchical navigation between workspaces, sessions, and messages
- [ ] Working file upload with drag-and-drop support
- [ ] Mode selection for messages
- [ ] Real-time message updates
- [ ] Proper error handling and loading states
- [ ] Responsive design for all screen sizes

## Review

### What Was Implemented

1. **Workspace Management**
   - Created `/workspaces` route with table view of all workspaces
   - Implemented multi-step CreateWorkspaceDialog following the spec
   - Added EditWorkspaceDialog for updating workspace configurations
   - Real-time connection status checking for each workspace

2. **Hierarchical Navigation**
   - Routes: `/workspaces` → `/workspaces/[id]` → `/workspaces/[id]/sessions/[sessionId]`
   - Breadcrumb navigation throughout the hierarchy
   - Updated main navigation to link to workspaces

3. **Session Management Updates**
   - Fixed CreateSessionDialog to accept workspace context
   - Updated SessionList to be a presentation component (no queries)
   - Modified SessionCard to use workspace-aware routes

4. **Message Interface Enhancements**
   - Added mode selector with options: chat, code, explain, summarize, fix, refactor
   - Integrated FileDropZone for drag-and-drop file uploads
   - Badge display for uploaded files with remove functionality
   - Mode and file state management in MessageInput component

5. **Query Layer Updates**
   - Created `messages.ts` with sendMessage mutation
   - Properly integrated workspace context throughout
   - Re-exported messages in query index

6. **Navigation & UX**
   - Homepage redirects to workspaces (single workspace goes directly to it)
   - Breadcrumb navigation on all workspace/session pages
   - Connection status indicators with real-time checking

### Key Design Decisions

1. **Connection Status**: Dynamically checked via API calls, not persisted
2. **No Active Workspace**: Each operation explicitly requires workspace selection
3. **File Upload**: Uses existing FileDropZone from @repo/ui, matching the drag-and-drop pattern from the other app
4. **Message Modes**: Comprehensive set of modes for different AI interactions

### What Still Needs Work

1. **Provider/Model Selection**: Currently hardcoded to OpenAI/gpt-4o-mini in message sending
2. **File Upload Backend**: Frontend is ready but needs backend implementation
3. **Error States**: Basic error handling is in place but could be enhanced
4. **Loading States**: Skeleton loaders exist but could be more comprehensive
5. **Empty States**: Basic empty states implemented, could be more visually appealing

### Next Steps

1. Implement provider/model selection (possibly as workspace settings)
2. Add file upload support in the backend
3. Polish UI with better loading and empty states
4. Add keyboard shortcuts for common actions
5. Implement workspace import/export functionality